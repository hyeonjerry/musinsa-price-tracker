<!doctype html>
<html layout:decorate="~{layout}">
<head>
  <title>MSS Price Tracker</title>
</head>
<body>

<div class="container" layout:fragment="content">
  <div class="my-5">
    <h3>가격 하락 상품</h3>
  </div>

  <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xxl-5 g-4" id="product-cards">
  </div>

  <div class="loading-spinner" id="loading-spinner"
       style="display: none; text-align: center; margin: 20px 0;">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div class="no-more-products" id="no-more-products"
       style="display: none; text-align: center; margin: 20px 0;">
    더 이상 상품이 없습니다.
  </div>
</div>

<th:blcok layout:fragment="script">
  <script src="/js/product-utils.js"></script>
  <script src="/js/product-card-generator.js"></script>
  <script>
    let currentPage = 1;
    let isLoading = false;

    document.addEventListener('DOMContentLoaded', () => {
      fetchProducts();
      window.addEventListener('scroll', handleScroll);
    });

    function fetchProducts() {
      if (isLoading) {
        return;
      }
      isLoading = true;
      const spinner = document.getElementById('loading-spinner');
      spinner.style.display = 'block';

      fetch(`/api/products/price-drop?page=${currentPage}`)
      .then(response => response.json())
      .then(products => {
        if (products.length === 0) {
          isLoading = true;
          spinner.style.display = 'none';
          document.getElementById('no-more-products').style.display = 'block';
          return;
        }

        const fragment = document.createDocumentFragment();
        products.forEach(product => {
          const card = mapToCard(product);
          fragment.appendChild(card);
        });
        document.getElementById('product-cards').appendChild(fragment);
        currentPage++;
        isLoading = false;
        spinner.style.display = 'none';
      });
    }

    function mapToCard(product) {
      const line1 = `원가: ${formatPrice(product.normalPrice)}원`;
      const line2 = `현재 가격: ${formatPrice(product.latestPrice)}원`;
      const line3 = `1주일 최고가: ${formatPrice(product.weeklyHighestPrice)}원`;
      return generate(product.id, product.name, product.imageUrl, line1, line2, line3);
    }

    function handleScroll() {
      if (isBottom()) {
        fetchProducts();
      }
    }
  </script>
</th:blcok>
</body>
</html>
